// prisma/schema.prisma
// Database schema for CabinetViz customer portal
// Updated: Force rebuild

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  company       String?
  phone         String?
  avatar        String?
  role          String    @default("CUSTOMER") // CUSTOMER, ADMIN, DESIGNER

  // Relationships
  jobs                Job[]
  notifications       Notification[]
  subscription        Subscription?
  payments            Payment[]
  sentMessages        Message[] @relation("SentMessages")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// SUBSCRIPTIONS & PAYMENTS
// ============================================

// Pricing Plans Configuration
// BASIC: $99/project - Single project, 2 renders, 1 revision
// PROFESSIONAL: $199/project - Full project, 5 renders, 3 revisions
// PARTNER: $499/month - Up to 5 projects/month, unlimited renders & revisions

model Subscription {
  id              String    @id @default(cuid())

  // Plan Details
  plan            String    // PARTNER (only subscription plan)
  status          String    @default("ACTIVE") // ACTIVE, PAUSED, CANCELLED, EXPIRED, PENDING

  // Billing Cycle
  billingCycle    String    @default("MONTHLY") // MONTHLY, YEARLY
  pricePerCycle   Float     @default(499) // $499/month for Partner

  // Dates
  startDate       DateTime  @default(now())
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime
  cancelledAt     DateTime?

  // Usage Tracking (for Partner plan: 5 projects/month)
  projectsUsedThisMonth Int @default(0)
  projectsLimit   Int       @default(5) // Partner gets 5/month
  lastResetDate   DateTime  @default(now()) // When usage was last reset

  // Payment Integration (future-ready)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  paymentMethod        String? // CARD, BANK_TRANSFER, INVOICE

  // Admin Notes
  notes           String?

  // Relationships
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Payment {
  id              String    @id @default(cuid())

  // Payment Details
  amount          Float
  originalAmount  Float?    // Amount before discount
  discountAmount  Float?    // Discount applied
  discountCode    String?   // Discount code used
  currency        String    @default("NZD")
  status          String    @default("PENDING") // PENDING, PAID, FAILED, REFUNDED, CANCELLED

  // Payment Type
  type            String    // SUBSCRIPTION, PROJECT, ONE_TIME
  description     String

  // Reference (what this payment is for)
  jobId           String?   // For project payments
  subscriptionMonth String? // For subscription: "2025-01" format

  // Invoice Details
  invoiceNumber   String?   @unique
  invoiceUrl      String?   // URL to PDF invoice
  invoiceSentAt   DateTime?

  // Payment Processing (future-ready for Stripe)
  stripePaymentIntentId String?
  stripeInvoiceId       String?
  paymentMethod         String? // CARD, BANK_TRANSFER, CASH, OTHER
  paidAt                DateTime?

  // Admin
  notes           String?
  processedBy     String?   // Admin who marked as paid

  // Relationships
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============================================
// DISCOUNTS & PROMOTIONS
// ============================================

model Discount {
  id              String    @id @default(cuid())

  // Discount Details
  code            String    @unique // Promo code (e.g., "SUMMER20", "WELCOME10")
  name            String    // Display name
  description     String?

  // Discount Type
  type            String    // PERCENTAGE, FIXED_AMOUNT
  value           Float     // 20 for 20% or 50 for $50 off

  // Scope
  scope           String    @default("ALL") // ALL (site-wide), SUBSCRIPTION, PROJECT, USER_SPECIFIC
  applicablePlans String?   // Comma-separated: "BASIC,PROFESSIONAL" or null for all

  // User-specific discount (for customer-centric discounts)
  userId          String?   // If set, only this user can use it

  // Limits
  maxUses         Int?      // Total uses allowed (null = unlimited)
  maxUsesPerUser  Int       @default(1) // Uses per user
  usedCount       Int       @default(0) // Current total uses
  minOrderValue   Float?    // Minimum order value to apply

  // Validity
  isActive        Boolean   @default(true)
  startDate       DateTime  @default(now())
  endDate         DateTime?

  // Tracking
  createdBy       String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Site-wide discount settings (global discount that applies to everyone)
model SiteDiscount {
  id              String    @id @default(cuid())

  // Only one active site discount at a time
  isActive        Boolean   @default(false)

  // Discount Details
  name            String    // e.g., "Christmas Sale", "New Year Special"
  type            String    // PERCENTAGE, FIXED_AMOUNT
  value           Float     // Discount value

  // Display
  bannerText      String?   // Text to show on website
  bannerColor     String?   // Banner background color

  // Scope
  appliesTo       String    @default("ALL") // ALL, SUBSCRIPTION, PROJECT

  // Validity
  startDate       DateTime
  endDate         DateTime

  createdBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============================================
// JOBS & PROJECTS
// ============================================

model Job {
  id            String      @id @default(cuid())
  jobNumber     String      @unique // e.g., "JOB-2024-001"
  title         String
  description   String?
  status        String      @default("PENDING") // PENDING, QUOTED, IN_PROGRESS, REVIEW, REVISION, COMPLETED, CANCELLED
  priority      String      @default("NORMAL") // LOW, NORMAL, HIGH, URGENT

  // Project Details
  projectType   String      // KITCHEN, WARDROBE, BATHROOM_VANITY, ENTERTAINMENT_UNIT, HOME_OFFICE, LAUNDRY, CUSTOM
  roomType      String?     // L_SHAPED, U_SHAPED, GALLEY, SINGLE_WALL, ISLAND, WALK_IN, REACH_IN, CUSTOM

  // Dimensions
  roomWidth     Float?
  roomLength    Float?
  roomHeight    Float?
  dimensionUnit String      @default("mm")

  // Style Preferences
  cabinetStyle  String?
  materialType  String?
  colorScheme   String?
  handleStyle   String?

  // Additional Info
  budget        Float?
  deadline      DateTime?
  notes         String?

  // Package/Pricing
  package       String      @default("PROFESSIONAL") // BASIC, PROFESSIONAL, PARTNER
  quotedPrice   Float?
  isPaid        Boolean     @default(false)
  paidAt        DateTime?
  paymentId     String?     // Reference to Payment record

  // Progress Tracking
  progress      Int         @default(0) // 0-100

  // Relationships
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  files         JobFile[]
  messages      Message[]
  statusHistory StatusHistory[]
  deliverables  Deliverable[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

// ============================================
// FILES & UPLOADS
// ============================================

model JobFile {
  id          String      @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  category    String      // MEASUREMENT, SKETCH, REFERENCE, PHOTO, FLOOR_PLAN, RENDER_3D, DRAWING_2D, CUT_LIST, OTHER

  // Relationships
  jobId       String
  job         Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  uploadedAt  DateTime    @default(now())
}

// ============================================
// DELIVERABLES
// ============================================

model Deliverable {
  id          String            @id @default(cuid())
  name        String
  description String?
  type        String            // RENDER_FRONT, RENDER_PERSPECTIVE, RENDER_TOP, RENDER_DETAIL, DRAWING_ELEVATION, DRAWING_PLAN, DRAWING_SECTION, CUT_LIST, ASSEMBLY_GUIDE, MATERIAL_LIST
  fileUrl     String
  fileSize    Int
  version     Int               @default(1)

  // Relationships
  jobId       String
  job         Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)

  createdAt   DateTime          @default(now())
}

// ============================================
// MESSAGES & COMMUNICATION
// ============================================

enum MessageStatus {
  SENT        // Message created
  DELIVERED   // Server received (immediate)
  READ        // Recipient viewed
}

model Message {
  id          String        @id @default(cuid())
  content     String

  // Sender info
  senderId    String
  sender      User          @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  // Job relationship
  jobId       String
  job         Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Message status
  status      MessageStatus @default(SENT)
  readAt      DateTime?

  // Internal notes (admin-only visibility)
  isInternal  Boolean       @default(false)

  // Timestamps
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// ============================================
// STATUS HISTORY
// ============================================

model StatusHistory {
  id          String    @id @default(cuid())
  fromStatus  String?
  toStatus    String
  note        String?
  changedBy   String

  // Relationships
  jobId       String
  job         Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  changedAt   DateTime  @default(now())
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String    @id @default(cuid())
  title       String
  message     String
  type        String    // JOB_CREATED, STATUS_UPDATE, NEW_COMMENT, DELIVERABLE_READY, QUOTE_SENT, PAYMENT_RECEIVED
  isRead      Boolean   @default(false)
  link        String?

  // Relationships
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
}

// ============================================
// THEME SETTINGS
// ============================================

model ThemeSetting {
  id          String    @id @default(cuid())
  key         String    @unique
  value       String    // JSON string for complex values
  category    String    // GENERAL, COLORS, TYPOGRAPHY, HERO, SERVICES, PRICING, TESTIMONIALS, FOOTER, IMAGES, SEO
  label       String    // Human-readable label
  type        String    // TEXT, TEXTAREA, COLOR, IMAGE, SELECT, NUMBER, BOOLEAN, JSON
  description String?
  options     String?   // JSON string for SELECT options

  updatedAt   DateTime  @updatedAt
  updatedBy   String?
}

// ============================================
// CUSTOM FESTIVALS & EVENTS
// ============================================

model CustomFestival {
  id            String    @id @default(cuid())
  name          String
  displayName   String

  // Date configuration
  startDate     DateTime  // Specific start date
  endDate       DateTime  // Specific end date (calculated from duration)
  duration      Int       @default(1) // Number of days
  isRecurring   Boolean   @default(false) // Repeat every year

  // Visual theme - stored as JSON
  colors        String    // JSON: { primary, secondary, accent }

  // Animation configuration
  animation     String    // Animation type: snowfall, fireworks, confetti, hearts, diyas, leaves, lanterns, stars, custom
  intensity     String    @default("medium") // low, medium, high
  customAnimation String? // JSON: Custom animation configuration with elements

  // Content
  greeting      String
  icon          String    // Emoji icon
  bannerText    String?   // Optional custom banner text

  // Targeting
  countries     String    // Comma-separated country codes or GLOBAL
  priority      Int       @default(50) // 1-100, higher = shown first

  // Status
  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?
}

// ============================================
// ANIMATION ELEMENTS LIBRARY
// ============================================

model AnimationElement {
  id            String    @id @default(cuid())
  name          String
  category      String    // FESTIVE, NATURE, CELEBRATION, RELIGIOUS, SEASONAL, CUSTOM

  // Element configuration
  emoji         String?   // Emoji representation
  svgPath       String?   // SVG path data for custom elements
  imageUrl      String?   // URL for image-based elements

  // Animation properties - stored as JSON
  defaultProps  String    // JSON: { size, speed, rotation, fade, etc. }

  // Metadata
  description   String?
  tags          String?   // Comma-separated tags for search
  isBuiltIn     Boolean   @default(false) // System vs user-created

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
